# 浏览器Chrome

> Chrome 每个Tab都分别对应一个呈现引擎实例，都是一个独立的进程，每个进程都会有一个主线程，网页的渲染（Style、Layout、Paint、Composite）会在主线程进行。  
> 主线程可以发起多个Web Worker，Web Worker对应“线程”的概念。

## 浏览器渲染原理 *Principle of browser rendering*

> GUI(Graphical User Interface)图形用户界面，是指采用图形方式显示的计算机操作界面。

- 渲染引擎（Rendering Engine）
    - 负责取得网页的内容（HTML、XML、图像等等）整理讯息（例如加入CSS等），以及计算网页的显示方式，然后输出至显示器或打印机。浏览器的内核不同对于网页的语法解释会有不同，所以渲染的效果也不相同。

- JavaScript引擎
    - 一个专门处理JavaScript脚本的虚拟机（**程序虚拟机**），一般会附带在网页浏览器中。
    - 能够解释JavaScript代码，并且通过DOM接口和CSSOM接口来修改网页内容和样式信息，从而改变渲染结果。

#### JavaScript引擎和渲染引擎的关系
    网页的工作需要两个引擎：渲染引擎和JS引擎。JS引擎复制执行JS代码，渲染引擎复制渲染网页。
    JS引擎提供调用接口给渲染引擎，以便让渲染引擎使用JS引擎来处理JS代码并获取结果。JS引擎需要能够访问渲染引擎构建的DOM树，所有JS隐藏通常需要提供桥接的接口，渲染引擎根据桥接的接口来提供让JS访问DOM的能力。
> 两种引擎通过桥接接口来DOM结构，造成了性能的损失。所以目前为止使用JS操作DOM还是一个非常低效率的事。目前主流的解决方案是使用虚拟DOM的方式。

- 浏览器加载页面的过程：
    1. 解析HTML以重建DOM树：
      > 渲染引擎开始解析HTML文档，转换书中的标签到DOM节点，他被称为“内容树”。
    2. 构建渲染树：
      > 解析CSS（包括外部CSS文件和样式元素），根据CSS选择器计算出节点的样式创建另一个树————渲染树。
    3. 布局渲染树：
      > 从根节点递归调用，计算每一个元素的大小、位置等，给每个节点所应该出现在屏幕上的精确坐标。
    4. 绘制渲染树：
      > 遍历渲染树，每个节点将使用UI后端层来绘制。主要的流程就是：构建一个DOM树，页面要显示的各元素都会创建到这个DOM树中，每当一个新元素加入到这个DOM树时，浏览器便会通过CSS引擎查遍css样式表，找到符合该元素的样式规则应用到这个元素上。
    5. reflow（重排）：
      > 当浏览器发现页面的某个部分发生了点变化影响了布局后，需要倒回去重新渲染，这个回退的过程叫“reflow”。频繁的reflow会导致页面加载非常缓慢，要尽量减少reflow操作。比如树状目录的折叠、展开（实质上是元素的显示与隐藏）等，都将引起浏览器的reflow。鼠标滑过、点击...只要这些行为引起了页面上某些元素的 **占位面积、定位方式、边距等属性** 的变化，都会引起它内部、周围甚至整个页面的重新渲染。
    6. repaint（重绘）：
      > 如果只是改变某个元素的**背景色、文字颜色、边框颜色**等等**不影响它周围或内部布局**的属性，将只会引起浏览器repaint。

- GUI渲染线程与JS引擎线程是互斥的。
    > 当JS引擎执行时GUI线程会被挂起，GUI的更新也会被保存在一个队列中，等到JS引擎空闲时才有机会被执行。


